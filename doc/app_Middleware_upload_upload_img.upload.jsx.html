<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app/Middleware/upload/upload_img.upload.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app/Middleware/upload/upload_img.upload.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { PureComponent } from 'react';
import { connect } from 'react-redux';
import NProgress from 'nprogress';
import {
  Modal,
  Tabs,
  Icon,
  message,
  Divider,
  Tooltip,
  Button,
  Pagination,
  Row,
  Col,
} from 'antd';
import style from './img_lazy_choose.module.scss';
import UploadImgForm from './_img_form.upload';
import 'nprogress/nprogress.css';
import { redux_action } from '../../../database/redux/action';
import { upload_api } from '../../../api/upload.api';
import { user_api } from '../../../api/user.api';
import { delete_api } from '../../../api/delete.api';

/**
 * 逻辑
 *  1. 通过ajax 请求，获取用户是否存数据
 *  2. 如果存在数据则展示xxx, 如果不存在则展示默认
 *  3. 添加删除功能
 *  4. 添加选择功能，设置选择样式
 */
class UploadImg extends PureComponent {
  state = {
    visible: false,
    current: 1,
    upload: {
      upload: {
        value: '',
      },
    },
    number: 0,
    img_library: [],
  };

  componentWillMount() {
    user_api(this.props.type, 1).then(response => {
      this.setState({
        number: JSON.parse(response.sum),
        img_library: response.list,
      });
    });
  }

  showModal = () => {
    this.setState({
      visible: true,
    });
  };
  closeModal = () => {
    this.setState({
      visible: false,
    });
  };
  uploadChange = field => {
    const file = field.upload.value.file;
    NProgress.start();
    if (file.status === 'done') {
      upload_api(
        this.props.type,
        file.response.key,
        `http://src.e7wei.com/${file.response.key}`
      )
        .then(() => {
          NProgress.done();
          message.success('上传成功');
          user_api(this.props.type, 0)
            .then(response => {
              this.setState({
                img_library: response.list,
                current: 1,
                number: response.sum,
              });
            })
            .catch(response => {
              message.error(response);
            });
        })
        .catch(() => {
          NProgress.done();
          message.error('上传失败，请重新尝试');
        });
    }
  };
  onChange = page => {
    user_api(this.props.type, page)
      .then(response => {
        this.setState({
          img_library: response.list,
          current: page,
          number: response.sum,
        });
      })
      .catch(response => {
        message.error(response);
      });
  };
  choose_img = url => {
    NProgress.done();
    // 图片
    if (this.props.type === 1) {
      this.props.func(url);
    }
    if (this.props.type === 3) {
      this.props.func(url);
    }
    if (this.props.type === 2) {
      this.props.func(url);
    }
  };
  delete = mid => {
    NProgress.start();
    delete_api(mid)
      .then(() => {
        NProgress.done();
        user_api(this.props.type, this.state.current)
          .then(response => {
            this.setState({
              number: JSON.parse(response.sum),
              img_library: response.list,
            });
            message.success('删除成功');
          })
          .catch(() => {
            this.setState({
              number: 0,
              img_library: [],
            });
            message.success('删除成功');
          });
      })
      .catch(() => {
        NProgress.done();
        message.error('删除失败');
      });
  };

  render() {
    // model 默认内容
    const default_model = (
      &lt;div style={{ textAlign: 'center', padding: '0 80px' }}>
        &lt;img src={'http://src.e7wei.com/0.2823198691104869.png'} alt={'img'} />
        &lt;br />
        &lt;UploadImgForm
          type={2}
          onChange={this.uploadChange}
          child={
            &lt;Button type="dashed" style={{ width: '150px' }}>
              种植素材
            &lt;/Button>
          }
          {...this.state.upload}
        />
      &lt;/div>
    );
    // 当用户拥有上传数据时
    const show_data = (
      &lt;React.Fragment>
        &lt;div
          style={{
            width: '100%',
            minHeight: '300px',
            maxHeight: '300px',
            overflow: 'auto',
          }}
        >
          &lt;div className={'response_flex'}>
            {this.state.img_library.map((data, index) => {
              return (
                &lt;div
                  className={'flex_1'}
                  key={index}
                  onClick={this.choose_img.bind(this, data.url)}
                >
                  &lt;Tooltip
                    title={
                      &lt;div
                        style={{ cursor: ' pointer' }}
                        onClick={this.delete.bind(this, data.mid, index)}
                      >
                        删除
                      &lt;/div>
                    }
                  >
                    &lt;div
                      className={
                        data.url === this.props.img_url
                          ? `${style.part_active}`
                          : `${style.part_choose}`
                      }
                    >
                      &lt;div className={style.img_show}>
                        &lt;img className={style.img} src={data.url} alt={'img'} />
                      &lt;/div>
                    &lt;/div>
                  &lt;/Tooltip>
                &lt;/div>
              );
            })}
          &lt;/div>
        &lt;/div>
        &lt;Divider />
        &lt;div style={{ padding: '0 35%', width: '100%' }}>
          &lt;Button
            onClick={this.closeModal}
            style={{ width: '100px', marginRight: '10px' }}
          >
            取消
          &lt;/Button>
          &lt;Button
            onClick={this.closeModal}
            style={{ width: '100px', marginRight: '10px' }}
          >
            确定
          &lt;/Button>
        &lt;/div>
      &lt;/React.Fragment>
    );
    return (
      &lt;React.Fragment>
        &lt;span onClick={this.showModal}>{this.props.children}&lt;/span>
        &lt;Modal
          width={800}
          title="我的素材"
          visible={this.state.visible}
          onCancel={this.closeModal}
          footer={null}
        >
          &lt;Tabs
            tabBarExtraContent={
              &lt;span>
                &lt;Row gutter={16} style={{ width: '300px' }}>
                  &lt;Col span={8} style={{ transform: 'translate(0,4px)' }}>
                    &lt;UploadImgForm
                      upload={{
                        value: '',
                      }}
                      onChange={this.uploadChange}
                      child={
                        &lt;div
                          style={{
                            color: '#19a0fa',
                            cursor: 'pointer',
                            marginRight: '10px',
                          }}
                        >
                          &lt;Icon type="plus" />
                          &amp;nbsp;添加素材
                        &lt;/div>
                      }
                    />
                  &lt;/Col>
                  &lt;Col span={16} style={{ transform: 'translate(0,11px)' }}>
                    &lt;Pagination
                      simple
                      pageSize={24}
                      total={this.state.number}
                      current={this.state.current}
                      onChange={this.onChange}
                    />
                  &lt;/Col>
                &lt;/Row>
              &lt;/span>
            }
          >
            &lt;Tabs.TabPane tab="我的素材" key="1">
              {this.state.img_library.length === 0 ? default_model : show_data}
            &lt;/Tabs.TabPane>
          &lt;/Tabs>
        &lt;/Modal>
      &lt;/React.Fragment>
    );
  }
}

const mapStateToProps = state => {
  return {
    // 核心组件
    h5_data_value: state.h5Data_rdc,
    // 背景组件样式
    bg_ui_value: state.bgUi_rdc,
  };
};

const mapDispatchToProps = dispatch => {
  return {
    upData: (name, data, meta) => dispatch(redux_action(name, data, meta)),
  };
};

export default connect(
  mapStateToProps,
  mapDispatchToProps
)(UploadImg);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BgComponent.html">BgComponent</a></li><li><a href="EighteenTextUi.html">EighteenTextUi</a></li><li><a href="EightTextUi.html">EightTextUi</a></li><li><a href="ElevenTextUi.html">ElevenTextUi</a></li><li><a href="FifteenTextUi.html">FifteenTextUi</a></li><li><a href="FiveTextUi.html">FiveTextUi</a></li><li><a href="FourTeenTextUi.html">FourTeenTextUi</a></li><li><a href="FourTextUi.html">FourTextUi</a></li><li><a href="ImgBaseForm.html">ImgBaseForm</a></li><li><a href="ImgCropFactory.html">ImgCropFactory</a></li><li><a href="ImgItemForm.html">ImgItemForm</a></li><li><a href="module.html#.exports">exports</a></li><li><a href="MusicUi.html">MusicUi</a></li><li><a href="NineTeenTextUi.html">NineTeenTextUi</a></li><li><a href="NineTextUi.html">NineTextUi</a></li><li><a href="RenderBg.html">RenderBg</a></li><li><a href="SevenTeenTextUi.html">SevenTeenTextUi</a></li><li><a href="SevenTextUi.html">SevenTextUi</a></li><li><a href="SixTeenTextUi.html">SixTeenTextUi</a></li><li><a href="SixTextUi.html">SixTextUi</a></li><li><a href="TenTextUi.html">TenTextUi</a></li><li><a href="ThirteenTextUi.html">ThirteenTextUi</a></li><li><a href="ThreeTextUi.html">ThreeTextUi</a></li><li><a href="TwelveTextUi.html">TwelveTextUi</a></li><li><a href="TwentyTextUi.html">TwentyTextUi</a></li><li><a href="TwoTextUi.html">TwoTextUi</a></li><li><a href="UploadImg.html">UploadImg</a></li></ul><h3>Global</h3><ul><li><a href="global.html#$$form">$$form</a></li><li><a href="global.html#$$from_opt_input">$$from_opt_input</a></li><li><a href="global.html#one_template">one_template</a></li><li><a href="global.html#render_formFactory">render_formFactory</a></li><li><a href="global.html#render_ui">render_ui</a></li><li><a href="global.html#secretKey">secretKey</a></li><li><a href="global.html#template">template</a></li><li><a href="global.html#template_button_data">template_button_data</a></li><li><a href="global.html#template_form_data">template_form_data</a></li><li><a href="global.html#template_img_data">template_img_data</a></li><li><a href="global.html#template_mall_data">template_mall_data</a></li><li><a href="global.html#template_text_data">template_text_data</a></li><li><a href="global.html#upload_api">upload_api</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Jul 27 2018 16:09:04 GMT+0800 (China Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
